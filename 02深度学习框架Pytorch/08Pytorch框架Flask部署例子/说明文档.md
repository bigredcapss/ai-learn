# PyTorch Flask 部署项目说明文档

## 项目概述

本项目演示了如何使用Flask框架部署PyTorch深度学习模型，实现图像分类的Web服务。项目包含一个Flask服务器和一个客户端预测脚本，可以接收图像输入并返回分类预测结果。

## 项目结构

```
08Pytorch框架Flask部署例子/
├── flask_server.py      # Flask服务器主文件
├── flask_predict.py     # 客户端预测脚本
├── best.pth            # 预训练模型权重文件（需要自行准备）
└── README.md           # 项目说明文档
```

## 核心功能

### 1. Flask服务器 (`flask_server.py`)

#### 主要功能
- 加载预训练的ResNet18模型
- 提供RESTful API接口进行图像分类
- 支持GPU加速（可选）
- 返回top-3预测结果

#### 关键组件

**模型加载 (`load_model`函数)**
```python
def load_model():
    global model
    model = models.resnet18()
    num_ftrs = model.fc.in_features
    model.fc = nn.Sequential(nn.Linear(num_ftrs, 102))  # 102个类别
    checkpoint = torch.load('best.pth')
    model.load_state_dict(checkpoint['state_dict'])
    model.eval()
```

**图像预处理 (`prepare_image`函数)**
- 将图像转换为RGB格式
- 调整图像尺寸为64x64
- 应用标准化处理
- 转换为PyTorch张量

**预测接口 (`/predict`路由)**
- 接收POST请求中的图像文件
- 调用模型进行预测
- 返回JSON格式的预测结果

#### API接口说明

**请求方式**: POST  
**接口地址**: `http://localhost:5012/predict`  
**请求参数**: 
- `image`: 图像文件（multipart/form-data）

**返回格式**:
```json
{
    "success": true,
    "predictions": [
        {"label": "0", "probability": 0.8234},
        {"label": "1", "probability": 0.1234},
        {"label": "2", "probability": 0.0532}
    ]
}
```

### 2. 客户端预测脚本 (`flask_predict.py`)

#### 主要功能
- 向Flask服务器发送图像文件
- 解析并显示预测结果
- 支持命令行参数指定图像路径

#### 使用方法
```bash
python flask_predict.py --file path/to/your/image.jpg
```

## 环境要求

### Python依赖包
```
flask>=2.0.0
torch>=1.9.0
torchvision>=0.10.0
Pillow>=8.0.0
requests>=2.25.0
numpy>=1.21.0
```

### 系统要求
- Python 3.7+
- 可选：CUDA支持的GPU（用于加速推理）

## 安装和配置

### 1. 安装依赖
```bash
pip install flask torch torchvision Pillow requests numpy
```

### 2. 准备模型文件
将训练好的模型权重文件 `best.pth` 放置在项目根目录下。

### 3. 配置参数
在 `flask_server.py` 中可以调整以下参数：
- `use_gpu`: 是否使用GPU加速（默认False）
- 模型路径和类别数
- 图像预处理参数

## 使用步骤

### 1. 启动Flask服务器
```bash
python flask_server.py
```
服务器将在 `http://localhost:5012` 启动。

### 2. 发送预测请求
使用客户端脚本：
```bash
python flask_predict.py --file test_image.jpg
```

或使用curl命令：
```bash
curl -X POST -F "image=@test_image.jpg" http://localhost:5012/predict
```

## 技术特点

### 1. 模型架构
- 基于ResNet18预训练模型
- 修改最后的全连接层适配102个类别
- 支持模型权重加载和保存

### 2. 图像处理
- 统一的图像预处理流程
- 支持多种图像格式
- 标准化处理确保模型输入一致性

### 3. Web服务
- RESTful API设计
- JSON格式数据交换
- 错误处理和状态反馈

### 4. 性能优化
- 模型单例模式避免重复加载
- 支持GPU加速推理
- 批量处理能力（可扩展）

## 扩展功能

### 1. 添加新的模型
修改 `load_model` 函数，加载不同的预训练模型：
```python
# 例如使用ResNet50
model = models.resnet50()
```

### 2. 支持批量预测
修改 `/predict` 接口，支持多图像同时预测。

### 3. 添加认证机制
集成JWT或其他认证方式保护API接口。

### 4. 日志记录
添加详细的请求日志和错误日志。

### 5. 健康检查接口
添加 `/health` 接口用于服务状态监控。

## 常见问题

### 1. 模型文件不存在
确保 `best.pth` 文件存在于项目根目录。

### 2. 端口被占用
修改 `app.run(port='5012')` 中的端口号。

### 3. GPU内存不足
设置 `use_gpu = False` 使用CPU推理。

### 4. 图像格式不支持
确保图像为常见格式（JPG、PNG等）。

## 部署建议

### 开发环境
- 直接运行 `python flask_server.py`
- 适合开发和测试

### 生产环境
- 使用Gunicorn或uWSGI作为WSGI服务器
- 配置Nginx作为反向代理
- 使用Docker容器化部署
- 添加负载均衡和监控

### Docker部署示例
```dockerfile
FROM python:3.8-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 5012
CMD ["python", "flask_server.py"]
```

## 总结

本项目提供了一个完整的PyTorch模型Flask部署解决方案，包括：
- 模型加载和推理
- Web API接口
- 客户端调用示例
- 完整的错误处理

通过这个项目，您可以快速将训练好的PyTorch模型部署为Web服务，为实际应用提供AI能力支持。
